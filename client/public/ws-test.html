<!DOCTYPE html>
<html>
<head>
  <title>WebSocket Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
    .container { max-width: 800px; margin: 0 auto; }
    .log { background: #f5f5f5; padding: 10px; border-radius: 5px; height: 300px; overflow-y: auto; }
    .message { margin-bottom: 10px; }
    .sent { color: blue; }
    .received { color: green; }
    .error { color: red; }
    input[type="text"] { width: 80%; padding: 5px; }
    button { padding: 5px 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebSocket Test</h1>
    <div>
      <p>Status: <span id="status">Not connected</span></p>
      <button id="connect">Connect</button>
      <button id="disconnect">Disconnect</button>
    </div>
    
    <h2>Messages</h2>
    <div class="log" id="log"></div>
    
    <div style="margin-top: 20px;">
      <input type="text" id="message" placeholder="Type a message...">
      <button id="send">Send</button>
    </div>
    
    <h2>Quick Actions</h2>
    <div>
      <button id="ping">Send Ping</button>
      <button id="subscribe">Subscribe to Updates</button>
      <button id="test">Send Test Message</button>
    </div>
  </div>

  <script>
    let socket = null;
    const statusElem = document.getElementById('status');
    const logElem = document.getElementById('log');
    const messageInput = document.getElementById('message');
    
    // Update the status display
    function updateStatus(state) {
      statusElem.textContent = state;
      statusElem.style.color = state === 'Connected' ? 'green' : 
                              state === 'Connecting...' ? 'orange' : 'red';
    }
    
    // Log a message
    function logMessage(text, type) {
      const messageElem = document.createElement('div');
      messageElem.className = `message ${type}`;
      messageElem.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
      logElem.appendChild(messageElem);
      logElem.scrollTop = logElem.scrollHeight;
    }
    
    // Connect to WebSocket server
    function connect() {
      if (socket && socket.readyState === WebSocket.OPEN) {
        logMessage('Already connected', 'error');
        return;
      }
      
      try {
        updateStatus('Connecting...');
        
        // Use the correct WebSocket URL for the current environment
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        
        logMessage(`Connecting to ${wsUrl}`, 'info');
        socket = new WebSocket(wsUrl);
        
        socket.onopen = function() {
          updateStatus('Connected');
          logMessage('Connection established', 'info');
        };
        
        socket.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data);
            logMessage(`Received: ${JSON.stringify(data, null, 2)}`, 'received');
          } catch (e) {
            logMessage(`Received (text): ${event.data}`, 'received');
          }
        };
        
        socket.onclose = function(event) {
          updateStatus('Disconnected');
          logMessage(`Connection closed: ${event.code} ${event.reason}`, 'info');
          socket = null;
        };
        
        socket.onerror = function(error) {
          updateStatus('Error');
          logMessage(`Error: ${error}`, 'error');
        };
      } catch (error) {
        updateStatus('Error');
        logMessage(`Connection error: ${error.message}`, 'error');
      }
    }
    
    // Disconnect from the server
    function disconnect() {
      if (!socket) {
        logMessage('Not connected', 'error');
        return;
      }
      
      socket.close();
      updateStatus('Disconnected');
      logMessage('Manually disconnected', 'info');
    }
    
    // Send a message
    function sendMessage(message) {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        logMessage('Cannot send: Not connected', 'error');
        return;
      }
      
      try {
        const messageStr = typeof message === 'string' ? message : JSON.stringify(message);
        socket.send(messageStr);
        logMessage(`Sent: ${messageStr}`, 'sent');
      } catch (error) {
        logMessage(`Send error: ${error.message}`, 'error');
      }
    }
    
    // Event listeners
    document.getElementById('connect').addEventListener('click', connect);
    document.getElementById('disconnect').addEventListener('click', disconnect);
    
    document.getElementById('send').addEventListener('click', function() {
      const message = messageInput.value.trim();
      if (message) {
        try {
          // Try to parse as JSON, otherwise send as text
          const jsonMessage = JSON.parse(message);
          sendMessage(jsonMessage);
        } catch (e) {
          sendMessage(message);
        }
        messageInput.value = '';
      }
    });
    
    messageInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('send').click();
      }
    });
    
    document.getElementById('ping').addEventListener('click', function() {
      sendMessage({ type: 'ping', timestamp: new Date().toISOString() });
    });
    
    document.getElementById('subscribe').addEventListener('click', function() {
      sendMessage({ 
        type: 'subscribe', 
        channel: 'updates',
        timestamp: new Date().toISOString() 
      });
    });
    
    document.getElementById('test').addEventListener('click', function() {
      sendMessage({ 
        type: 'test', 
        data: 'This is a test message',
        timestamp: new Date().toISOString() 
      });
    });
    
    // Add health check link
    const healthCheckLink = document.createElement('p');
    healthCheckLink.innerHTML = '<a href="/api/health" target="_blank">Check API Health Status</a>';
    document.querySelector('.container').appendChild(healthCheckLink);
    
    // Add websocket test endpoint link
    const wsTestLink = document.createElement('p');
    wsTestLink.innerHTML = '<a href="/api/ws-test" target="_blank">Trigger WebSocket Broadcast</a>';
    document.querySelector('.container').appendChild(wsTestLink);
    
    // Add cookies display
    const cookieInfo = document.createElement('div');
    cookieInfo.innerHTML = `
      <h3>Cookie Information</h3>
      <p>Current cookies: <pre id="cookie-display">${document.cookie || 'No cookies'}</pre></p>
      <p><a href="/api/auth/test-cookie" target="_blank">Set Test Cookie</a> | 
         <a href="/api/auth/check-test-cookie" target="_blank">Check Test Cookie</a></p>
    `;
    document.querySelector('.container').appendChild(cookieInfo);
    
    // Periodically update the cookie display
    setInterval(() => {
      document.getElementById('cookie-display').textContent = document.cookie || 'No cookies';
    }, 5000);
  </script>
</body>
</html>
